{% extends "blog/_base.html" %}

{% block blog_content %}

<div class="institucional">
    <h2>Estudos sobre o DataViva</h2>
    <h3>Aprovação dos estudos</h3>
    <div class="meta">
        <table id="approvalTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Title<i class="fa fa-fw fa-sort"></i></th>
                    <th>Author(s)<i class="fa fa-fw fa-sort"></i></th>
                    <th>Publication Date<i class="fa fa-fw fa-sort"></i></th>
                    <th>Active <input name="select-all" value="1" id="select-all" type="checkbox"/></th>
                </tr>
            </thead>
        </table>
    </div>
<a class="btn btn-primary pull-right" href="/blog">Voltar</a>
<a class="btn btn-primary pull-right" href="#">Excluir</a>
<a class="btn btn-primary pull-right" href="#">Editar</a>
<a class="btn btn-primary pull-right" href="/blog/post/new">Novo</a>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<script type="text/javascript">
    var ScholarApproval = function () {
        this.table = $('#approvalTable').DataTable( {
            "sAjaxSource": "/blog/all",
            "sAjaxDataProp": "posts",
            "aoColumnsDefs": [
                { "data": "postselector" },
                { "data": "title" },
                { "data": "authors" },
                { "data": "publicationDate" },
                { "data": "active" },
            ],
            "columnDefs": [
                {
                    "targets": 0,
                    "orderable": false,
                    "className": "body-checkbox",
                    "render": function (data, type, post, meta){
                        return '<input type="checkbox" name="postselector" value="'+post[0]+'">';
                    }
                },
                {
                    "targets": 1,
                    "className": "body-title"
                },
                {
                     "targets": 4,
                     "className": "body-checkbox",
                     "render": function (data, type, post, meta){
                         if (data){
                            return '<input type="checkbox" name="checkboxApproval" value="'+post[0]+'" checked>';
                         }
                         else {
                            return '<input type="checkbox" name="checkboxApproval" value="'+post[0]+'">';
                         }
                     }
                  }],
            "columns": [
                    { "width": "8%" },
                    null,
                    null,
                    { "width": "20%" },
                    { "width": "12%" }
            ],
            "paging": false,
            "bFilter": false,
            "info": false,
        });
    };

    ScholarApproval.prototype.links = function(){
        $('#approvalTable tbody').on('click','.body-title', function () {
            var postId = parseInt($(this).closest('tr')[0].cells[0].textContent)
            window.location.href = '/blog/post/'+postId
        });
    };

    ScholarApproval.prototype.multipleCheckbox = function(){
        $('#approvalTable thead').on('click','#select-all', function () {
            var posts = {};
            $('input[name="checkboxApproval"]').each(function() {
                posts[this.value] = this.checked;
            });
            sendCheckedArticle(posts);
        });
    };

    ScholarApproval.prototype.singleCheckbox = function(){
        $('#approvalTable tbody').on('click','.body-checkbox', function () {
            var post = {};
            post[this.firstElementChild.value] = this.firstElementChild.checked;
            sendCheckedArticle(post);
        });
    };

    ScholarApproval.prototype.controlCheckbox = function(approvalTable){
        $('#select-all').on('click', function(){
           var rows = approvalTable.table.rows({ 'search': 'applied' }).nodes();
           $('input[type="checkbox"]', rows).prop('checked', this.checked);
        });

        $('#approvalTable tbody').on('change', 'input[type="checkbox"]', function(){
           if(!this.checked){
              var el = $('#select-all').get(0);
              if(el && el.checked && ('indeterminate' in el)){
                 el.indeterminate = true;
                }
            }
        });
    };

    var approvalTable = new ScholarApproval();
    approvalTable.links();
    approvalTable.multipleCheckbox();
    approvalTable.singleCheckbox();
    approvalTable.controlCheckbox(approvalTable);

    function sendCheckedArticle(postsApproval){
        var lang = $('html').attr('lang');
        $.ajax({
          method: "POST",
          url: "/"+lang+"/blog/approval",
          data: postsApproval,
          success: function (msg) {
          }
        })
    }
</script>
{% endblock blog_content %}